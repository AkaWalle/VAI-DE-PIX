version: '3.8'

# Docker Compose otimizado para Raspberry Pi 5
# Usa menos recursos e configurações específicas para ARM64

services:
  # PostgreSQL Database (usando imagem ARM64)
  postgres:
    image: postgres:15-alpine
    platform: linux/arm64
    environment:
      POSTGRES_DB: vai_de_pix
      POSTGRES_USER: vai_de_pix_user
      POSTGRES_PASSWORD: vai_de_pix_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vai_de_pix_user -d vai_de_pix"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Limitar recursos para RPi 5
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # FastAPI Backend (otimizado para RPi 5)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.arm64
    platform: linux/arm64
    environment:
      DATABASE_URL: postgresql://vai_de_pix_user:vai_de_pix_pass@postgres:5432/vai_de_pix
      SECRET_KEY: dev-secret-key-change-in-production
      FRONTEND_URL: http://localhost:8080
      GUNICORN_WORKERS: 2  # Menos workers para RPi 5
      PORT: 8000
      ENVIRONMENT: production
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend:/app
      - backend_logs:/app/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Limitar recursos para RPi 5
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

  # Frontend (servido pelo backend em produção)
  # Este serviço é opcional - o backend já serve o frontend buildado
  # frontend:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.frontend
  #   platform: linux/arm64
  #   environment:
  #     VITE_API_URL: http://localhost:8000/api
  #   ports:
  #     - "8080:8080"
  #   depends_on:
  #     - backend
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1.0'
  #         memory: 512M

volumes:
  postgres_data:
    driver: local
  backend_logs:
    driver: local

